<!-- Generated by SpecStory -->

# 收益列表勾选学员数据分析 (2025-05-06 10:26:28)

_**User**_

收益列表支持勾选学员，ai分析只分析勾选的学员数据。不要修改其他功能

---

_**Assistant**_

我将帮你修改收益列表，添加勾选功能，并修改AI分析以支持只分析勾选的学员数据。我会保持其他功能不变。

首先，我需要修改表格结构，添加复选框列：

---

```diff
                  <thead>
                      <tr>
+                         <th><input type="checkbox" id="selectAllCheckbox" onclick="toggleAllCheckboxes(this)"></th>
                          <th>微信名</th>
                          <th>报名课程</th>
```

```diff
                          
                          tr.innerHTML = `
+                             <td><input type="checkbox" class="student-checkbox" data-student-id="${student.id}"></td>
                              <td>${student.wechatName || '-'}</td>
                              <td>${student.courseName ? student.courseName.replace(/【|】/g, '') : '-'}</td>
```

```diff
                      
                      return {
-                         wechatName: cells[0].textContent,
-                         courseName: cells[1].textContent,
-                         channel: cells[2].textContent,
-                         status: cells[3].textContent.trim(),
-                         preferredTime: cells[4].textContent,
-                         enrollDate: cells[5].textContent,
-                         refundDate: cells[6].textContent,
-                         classStartDate: cells[7].textContent,
-                         className: cells[8].textContent,
-                         remarks: cells[9].textContent,
-                         amount: parseFloat(cells[10].textContent.replace('¥', '')),
-                         recruitmentIncome: parseFloat(cells[11].textContent.replace('¥', '')),
-                         channelCost: parseFloat(cells[12].textContent.replace('¥', ''))
+                         wechatName: cells[1].textContent,
+                         courseName: cells[2].textContent,
+                         channel: cells[3].textContent,
+                         status: cells[4].textContent.trim(),
+                         preferredTime: cells[5].textContent,
+                         enrollDate: cells[6].textContent,
+                         refundDate: cells[7].textContent,
+                         classStartDate: cells[8].textContent,
+                         className: cells[9].textContent,
+                         remarks: cells[10].textContent,
+                         amount: parseFloat(cells[11].textContent.replace('¥', '')),
+                         recruitmentIncome: parseFloat(cells[12].textContent.replace('¥', '')),
+                         channelCost: parseFloat(cells[13].textContent.replace('¥', ''))
                      };
                  }).filter(item => item !== null);
```

```diff
                      // 构建更新数据对象
                      const updateData = {
-                         wechatName: cell.closest('tr').querySelector('td:first-child').textContent,
+                         wechatName: cell.closest('tr').querySelector('td:nth-child(2)').textContent,
                          [field]: newValue
                      };
```

```diff
              }, 0);
          }
+ 
+         function toggleAllCheckboxes(checkbox) {
+             const checkboxes = document.querySelectorAll('.student-checkbox');
+             checkboxes.forEach(cb => cb.checked = checkbox.checked);
+         }
      </script>
  </body>
```

---

现在我需要修改AI分析功能，使其只分析勾选的学员数据：

---

```diff
          async function requestAIAnalysis() {
              try {
+                 // 获取勾选的学员
+                 const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
+                 if (selectedCheckboxes.length === 0) {
+                     showErrorMessage('请至少选择一名学员进行分析');
+                     return;
+                 }
+ 
                  // 获取当前筛选条件
                  const statusFilter = document.getElementById('statusFilter').value;
```

```diff
                  document.getElementById('aiAnalysisSection').scrollIntoView({ behavior: 'smooth' });
                  
-                 // 准备收益数据
-                 const totalIncome = parseFloat(document.getElementById('totalIncome').textContent.replace('¥', ''));
-                 const recruitmentIncome = parseFloat(document.getElementById('recruitmentIncome').textContent.replace('¥', ''));
-                 const channelCost = parseFloat(document.getElementById('channelCost').textContent.replace('¥', ''));
-                 const netIncome = parseFloat(document.getElementById('netIncome').textContent.replace('¥', ''));
+                 // 获取选中学员的数据
+                 const selectedStudentIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.studentId);
+                 const selectedRows = Array.from(document.querySelectorAll('#incomeTableBody tr')).filter(row => {
+                     const checkbox = row.querySelector('.student-checkbox');
+                     return checkbox && checkbox.checked;
+                 });
  
-                 // 获取详细数据
-                 const tableRows = Array.from(document.querySelectorAll('#incomeTableBody tr'));
-                 const detailsData = tableRows.map(row => {
+                 // 计算选中学员的总收益
+                 let totalIncome = 0;
+                 let recruitmentIncome = 0;
+                 let channelCost = 0;
+ 
+                 selectedRows.forEach(row => {
                      const cells = row.querySelectorAll('td');
-                     if (cells.length < 13) return null;
-                     
+                     const amount = parseFloat(cells[12].textContent.replace('¥', '')) || 0;
+                     const recruitment = parseFloat(cells[13].textContent.replace('¥', '')) || 0;
+                     const channel = parseFloat(cells[14].textContent.replace('¥', '')) || 0;
+                     
+                     if (cells[4].textContent.includes('已支付') || 
+                         cells[4].textContent.includes('已开班') || 
+                         cells[4].textContent.includes('已结算')) {
+                         totalIncome += amount;
+                         recruitmentIncome += recruitment;
+                         channelCost += channel;
+                     }
+                 });
+ 
+                 // 获取选中学员的详细数据
+                 const detailsData = selectedRows.map(row => {
+                     const cells = row.querySelectorAll('td');
                      return {
                          wechatName: cells[1].textContent,
```

```diff
                          className: cells[9].textContent,
                          remarks: cells[10].textContent,
-                         amount: parseFloat(cells[11].textContent.replace('¥', '')),
-                         recruitmentIncome: parseFloat(cells[12].textContent.replace('¥', '')),
-                         channelCost: parseFloat(cells[13].textContent.replace('¥', ''))
+                         institution: cells[11].textContent,
+                         amount: parseFloat(cells[12].textContent.replace('¥', '')),
+                         recruitmentIncome: parseFloat(cells[13].textContent.replace('¥', '')),
+                         channelCost: parseFloat(cells[14].textContent.replace('¥', ''))
                      };
-                 }).filter(item => item !== null);
+                 });
                  
                  // 准备发送到服务器的数据
```

```diff
                      recruitmentIncome,
                      channelCost,
-                     netIncome,
-                     details: detailsData
+                     netIncome: recruitmentIncome - channelCost,
+                     details: detailsData,
+                     selectedStudentCount: selectedCheckboxes.length
                  };
-                 console.log('准备发送的数据:', JSON.stringify(incomeData));
+ 
                  const filters = {
                      status: statusFilter,
```

```diff
                  
                  // 显示分析结果
-                 document.getElementById('aiAnalysisResult').innerHTML = formattedAnalysis;
+                 document.getElementById('aiAnalysisResult').innerHTML = `
+                     <div style="margin-bottom: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
+                         <strong>已选择 ${selectedCheckboxes.length} 名学员进行分析</strong>
+                     </div>
+                     ${formattedAnalysis}
+                 `;
                  
              } catch (error) {
```

---

最后，我需要添加一些样式来美化复选框：

---

```diff
              background-color: #45a049;
          }
+ 
+         /* 复选框样式 */
+         .student-checkbox, #selectAllCheckbox {
+             width: 18px;
+             height: 18px;
+             cursor: pointer;
+             border: 2px solid #4CAF50;
+             border-radius: 3px;
+             position: relative;
+             transition: all 0.2s ease;
+             vertical-align: middle;
+         }
+ 
+         .student-checkbox:checked, #selectAllCheckbox:checked {
+             background-color: #4CAF50;
+         }
+ 
+         .student-checkbox:hover, #selectAllCheckbox:hover {
+             border-color: #45a049;
+         }
+ 
+         /* 表格第一列（复选框列）的宽度 */
+         .income-table th:first-child,
+         .income-table td:first-child {
+             width: 40px;
+             text-align: center;
+             padding: 12px 8px;
+         }
+         
+         /* 选中行的样式 */
+         .income-table tr:has(.student-checkbox:checked) {
+             background-color: #f0f9eb;
+         }
      </style>
  </head>
```

---

我已经完成了所有必要的修改，现在收益列表支持勾选学员功能，并且AI分析只会分析勾选的学员数据。具体修改包括：

1. 添加了复选框列：
   - 在表格头部添加了"全选"复选框
   - 每行学员数据前添加了复选框
   - 实现了全选/取消全选功能

2. 修改了AI分析功能：
   - 只分析被勾选的学员数据
   - 在分析前检查是否有选中的学员
   - 显示已选择的学员数量
   - 计算选中学员的总收益、招生收益和渠道费

3. 添加了美化样式：
   - 美化了复选框外观
   - 选中的行会有浅绿色背景
   - 优化了复选框列的宽度和对齐方式

使用方法：
1. 在表格中勾选需要分析的学员（可以使用表头的全选框一键全选）
2. 点击"AI分析"按钮
3. 系统会只分析被勾选的学员数据
4. 分析结果会显示已选择的学员数量和详细分析内容

所有其他功能（如导出Excel、编辑数据等）都保持不变。

---

