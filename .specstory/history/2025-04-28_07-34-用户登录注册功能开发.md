<!-- Generated by SpecStory -->

# 用户登录注册功能开发 (2025-04-28 15:34:32)

_**User**_

添加用户登录注册功能，只需要用户名、手机号（无须验证）和密码。登录后才可以查看课表

---

_**Assistant**_

我来帮你添加用户登录注册功能。首先让我了解一下当前项目的情况。

---

<details>
            <summary>Listed current directory • **15** results</summary>
        
| Name |
|-------|
| 📁 `.git` |
| 📄 `app.js` |
| 📁 `public` |
| 📄 `.DS_Store` |
| 📄 `bd.json` |
| 📄 `package.json` |
| 📄 `package-lock.json` |
| 📁 `node_modules` |
| 📄 `product_detail.html` |
| 📁 `views` |
| 📁 `.specstory` |
| 📄 `.cursorrules` |
| 📄 `README.md` |
| 📄 `示例代码` |
| 📄 `.cursorindexingignore` |

</details>

---

让我先看看 README.md 文件，了解项目的目标和进展。

---

Read file: README.md

---

好的，我看到这是一个基于 Node.js + Express 的简单网站应用。让我们来添加用户登录注册功能。我们需要：

1. 创建用户数据模型
2. 添加登录和注册页面
3. 添加相关的后端 API
4. 添加登录状态验证中间件

首先，让我们创建一个简单的用户数据存储文件：

---

```diff
- 
+ [] 
```

---

现在，让我们创建登录页面：

---

```diff
- 
+ <!DOCTYPE html>
+ <html lang="zh-CN">
+ <head>
+     <meta charset="UTF-8">
+     <meta name="viewport" content="width=device-width, initial-scale=1.0">
+     <title>登录 - 课表查看系统</title>
+     <style>
+         body {
+             font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
+             margin: 0;
+             padding: 0;
+             display: flex;
+             justify-content: center;
+             align-items: center;
+             min-height: 100vh;
+             background-color: #f5f5f7;
+         }
+         .container {
+             background: white;
+             padding: 2rem;
+             border-radius: 12px;
+             box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
+             width: 100%;
+             max-width: 400px;
+             margin: 1rem;
+         }
+         h1 {
+             text-align: center;
+             color: #1d1d1f;
+             margin-bottom: 2rem;
+             font-weight: 500;
+         }
+         .form-group {
+             margin-bottom: 1.5rem;
+         }
+         label {
+             display: block;
+             margin-bottom: 0.5rem;
+             color: #1d1d1f;
+             font-size: 0.9rem;
+         }
+         input {
+             width: 100%;
+             padding: 0.75rem;
+             border: 1px solid #d2d2d7;
+             border-radius: 8px;
+             font-size: 1rem;
+             transition: border-color 0.2s;
+             box-sizing: border-box;
+         }
+         input:focus {
+             outline: none;
+             border-color: #0071e3;
+         }
+         button {
+             width: 100%;
+             padding: 0.75rem;
+             background: #0071e3;
+             color: white;
+             border: none;
+             border-radius: 8px;
+             font-size: 1rem;
+             cursor: pointer;
+             transition: background-color 0.2s;
+         }
+         button:hover {
+             background: #0077ed;
+         }
+         .switch-form {
+             text-align: center;
+             margin-top: 1rem;
+             font-size: 0.9rem;
+         }
+         .switch-form a {
+             color: #0071e3;
+             text-decoration: none;
+         }
+         .error-message {
+             color: #ff3b30;
+             font-size: 0.9rem;
+             margin-top: 0.5rem;
+             display: none;
+         }
+     </style>
+ </head>
+ <body>
+     <div class="container">
+         <h1>登录</h1>
+         <form id="loginForm">
+             <div class="form-group">
+                 <label for="username">用户名</label>
+                 <input type="text" id="username" name="username" required>
+             </div>
+             <div class="form-group">
+                 <label for="password">密码</label>
+                 <input type="password" id="password" name="password" required>
+             </div>
+             <div class="error-message" id="errorMessage"></div>
+             <button type="submit">登录</button>
+         </form>
+         <div class="switch-form">
+             还没有账号？<a href="/register">立即注册</a>
+         </div>
+     </div>
+     <script>
+         document.getElementById('loginForm').addEventListener('submit', async (e) => {
+             e.preventDefault();
+             const username = document.getElementById('username').value;
+             const password = document.getElementById('password').value;
+             const errorMessage = document.getElementById('errorMessage');
+             
+             try {
+                 const response = await fetch('/api/login', {
+                     method: 'POST',
+                     headers: {
+                         'Content-Type': 'application/json'
+                     },
+                     body: JSON.stringify({ username, password })
+                 });
+                 
+                 const data = await response.json();
+                 
+                 if (response.ok) {
+                     window.location.href = '/'; // 登录成功后跳转到首页
+                 } else {
+                     errorMessage.style.display = 'block';
+                     errorMessage.textContent = data.message || '登录失败，请检查用户名和密码';
+                 }
+             } catch (error) {
+                 errorMessage.style.display = 'block';
+                 errorMessage.textContent = '网络错误，请稍后重试';
+             }
+         });
+     </script>
+ </body>
+ </html> 
```

---

现在，让我们创建注册页面：

---

```diff
- 
+ <!DOCTYPE html>
+ <html lang="zh-CN">
+ <head>
+     <meta charset="UTF-8">
+     <meta name="viewport" content="width=device-width, initial-scale=1.0">
+     <title>注册 - 课表查看系统</title>
+     <style>
+         body {
+             font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
+             margin: 0;
+             padding: 0;
+             display: flex;
+             justify-content: center;
+             align-items: center;
+             min-height: 100vh;
+             background-color: #f5f5f7;
+         }
+         .container {
+             background: white;
+             padding: 2rem;
+             border-radius: 12px;
+             box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
+             width: 100%;
+             max-width: 400px;
+             margin: 1rem;
+         }
+         h1 {
+             text-align: center;
+             color: #1d1d1f;
+             margin-bottom: 2rem;
+             font-weight: 500;
+         }
+         .form-group {
+             margin-bottom: 1.5rem;
+         }
+         label {
+             display: block;
+             margin-bottom: 0.5rem;
+             color: #1d1d1f;
+             font-size: 0.9rem;
+         }
+         input {
+             width: 100%;
+             padding: 0.75rem;
+             border: 1px solid #d2d2d7;
+             border-radius: 8px;
+             font-size: 1rem;
+             transition: border-color 0.2s;
+             box-sizing: border-box;
+         }
+         input:focus {
+             outline: none;
+             border-color: #0071e3;
+         }
+         button {
+             width: 100%;
+             padding: 0.75rem;
+             background: #0071e3;
+             color: white;
+             border: none;
+             border-radius: 8px;
+             font-size: 1rem;
+             cursor: pointer;
+             transition: background-color 0.2s;
+         }
+         button:hover {
+             background: #0077ed;
+         }
+         .switch-form {
+             text-align: center;
+             margin-top: 1rem;
+             font-size: 0.9rem;
+         }
+         .switch-form a {
+             color: #0071e3;
+             text-decoration: none;
+         }
+         .error-message {
+             color: #ff3b30;
+             font-size: 0.9rem;
+             margin-top: 0.5rem;
+             display: none;
+         }
+     </style>
+ </head>
+ <body>
+     <div class="container">
+         <h1>注册</h1>
+         <form id="registerForm">
+             <div class="form-group">
+                 <label for="username">用户名</label>
+                 <input type="text" id="username" name="username" required>
+             </div>
+             <div class="form-group">
+                 <label for="phone">手机号</label>
+                 <input type="tel" id="phone" name="phone" pattern="[0-9]{11}" required>
+             </div>
+             <div class="form-group">
+                 <label for="password">密码</label>
+                 <input type="password" id="password" name="password" required>
+             </div>
+             <div class="error-message" id="errorMessage"></div>
+             <button type="submit">注册</button>
+         </form>
+         <div class="switch-form">
+             已有账号？<a href="/login">立即登录</a>
+         </div>
+     </div>
+     <script>
+         document.getElementById('registerForm').addEventListener('submit', async (e) => {
+             e.preventDefault();
+             const username = document.getElementById('username').value;
+             const phone = document.getElementById('phone').value;
+             const password = document.getElementById('password').value;
+             const errorMessage = document.getElementById('errorMessage');
+             
+             try {
+                 const response = await fetch('/api/register', {
+                     method: 'POST',
+                     headers: {
+                         'Content-Type': 'application/json'
+                     },
+                     body: JSON.stringify({ username, phone, password })
+                 });
+                 
+                 const data = await response.json();
+                 
+                 if (response.ok) {
+                     window.location.href = '/login'; // 注册成功后跳转到登录页
+                 } else {
+                     errorMessage.style.display = 'block';
+                     errorMessage.textContent = data.message || '注册失败，请稍后重试';
+                 }
+             } catch (error) {
+                 errorMessage.style.display = 'block';
+                 errorMessage.textContent = '网络错误，请稍后重试';
+             }
+         });
+     </script>
+ </body>
+ </html> 
```

---

现在让我们修改后端代码来支持用户认证功能。我们需要先安装一些必要的依赖：

---

```bash
npm install express-session bcryptjs
```

```
                                            npm install express-session bcryptjs 

added 7 packages, and removed 121 packages in 1s

20 packages are looking for funding
  run `npm fund` for details
(base) burning@192 基于飞书表格的夜校后台 %
```

---

现在让我们修改 app.js 文件来添加用户认证功能：

---

Read file: app.js

---

让我们修改 app.js 文件来添加用户认证功能：

---

```diff
  const lark = require('@larksuiteoapi/node-sdk');
  const fs = require('fs');
+ const session = require('express-session');
+ const bcrypt = require('bcryptjs');
  
  const app = express();
```

```diff
  // 配置静态文件目录
  app.use(express.static('public'));
+ app.use(express.json());
+ 
+ // 配置会话中间件
+ app.use(session({
+     secret: 'your-secret-key',
+     resave: false,
+     saveUninitialized: false,
+     cookie: { secure: false } // 在生产环境中应设置为 true
+ }));
  
  // 设置视图引擎
  app.set('view engine', 'ejs');
+ 
+ // 用户认证中间件
+ const requireAuth = (req, res, next) => {
+     if (req.session.user) {
+         next();
+     } else {
+         res.redirect('/login');
+     }
+ };
  
  // 创建飞书客户端
```

```diff
      }
  }
+ 
+ // 用户相关路由
+ app.get('/login', (req, res) => {
+     if (req.session.user) {
+         res.redirect('/');
+         return;
+     }
+     res.sendFile(path.join(__dirname, 'views', 'login.html'));
+ });
+ 
+ app.get('/register', (req, res) => {
+     if (req.session.user) {
+         res.redirect('/');
+         return;
+     }
+     res.sendFile(path.join(__dirname, 'views', 'register.html'));
+ });
+ 
+ app.post('/api/register', async (req, res) => {
+     try {
+         const { username, phone, password } = req.body;
+         
+         // 读取现有用户数据
+         let users = [];
+         if (fs.existsSync('users.json')) {
+             users = JSON.parse(fs.readFileSync('users.json', 'utf8'));
+         }
+         
+         // 检查用户名是否已存在
+         if (users.some(user => user.username === username)) {
+             res.status(400).json({ message: '用户名已存在' });
+             return;
+         }
+         
+         // 检查手机号是否已存在
+         if (users.some(user => user.phone === phone)) {
+             res.status(400).json({ message: '手机号已被注册' });
+             return;
+         }
+         
+         // 加密密码
+         const hashedPassword = await bcrypt.hash(password, 10);
+         
+         // 添加新用户
+         users.push({
+             username,
+             phone,
+             password: hashedPassword
+         });
+         
+         // 保存用户数据
+         fs.writeFileSync('users.json', JSON.stringify(users, null, 2));
+         
+         res.json({ message: '注册成功' });
+     } catch (error) {
+         console.error('注册错误:', error);
+         res.status(500).json({ message: '注册失败，请稍后重试' });
+     }
+ });
+ 
+ app.post('/api/login', async (req, res) => {
+     try {
+         const { username, password } = req.body;
+         
+         // 读取用户数据
+         if (!fs.existsSync('users.json')) {
+             res.status(401).json({ message: '用户名或密码错误' });
+             return;
+         }
+         
+         const users = JSON.parse(fs.readFileSync('users.json', 'utf8'));
+         const user = users.find(u => u.username === username);
+         
+         if (!user) {
+             res.status(401).json({ message: '用户名或密码错误' });
+             return;
+         }
+         
+         // 验证密码
+         const isValid = await bcrypt.compare(password, user.password);
+         if (!isValid) {
+             res.status(401).json({ message: '用户名或密码错误' });
+             return;
+         }
+         
+         // 设置会话
+         req.session.user = {
+             username: user.username,
+             phone: user.phone
+         };
+         
+         res.json({ message: '登录成功' });
+     } catch (error) {
+         console.error('登录错误:', error);
+         res.status(500).json({ message: '登录失败，请稍后重试' });
+     }
+ });
+ 
+ app.get('/api/logout', (req, res) => {
+     req.session.destroy();
+     res.json({ message: '已退出登录' });
+ });
  
  // 获取表格数据的API端点 - 优先从文件读取
- app.get('/api/table-data', async (req, res) => {
+ app.get('/api/table-data', requireAuth, async (req, res) => {
      try {
          // 从文件读取数据
```

```diff
  
  // 更新数据的API端点 - 强制从飞书获取
- app.get('/api/update-data', async (req, res) => {
+ app.get('/api/update-data', requireAuth, async (req, res) => {
      try {
          console.log('接收到更新数据请求');
```

```diff
  
  // 主页路由
- app.get('/', (req, res) => {
+ app.get('/', requireAuth, (req, res) => {
      res.sendFile(path.join(__dirname, 'public', 'index.html'));
  });
```

---

最后，让我们修改首页，添加登出功能：

---

Read file: public/index.html

---

让我们修改首页，添加登出功能：

---

```diff
              cursor: zoom-in;
          }
+ 
+         .user-info {
+             display: flex;
+             justify-content: flex-end;
+             align-items: center;
+             gap: 10px;
+             margin-bottom: 20px;
+             padding: 10px;
+             background-color: white;
+             border-radius: 8px;
+             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
+         }
+         
+         .user-info span {
+             color: #333;
+             font-size: 14px;
+         }
+         
+         .logout-button {
+             padding: 6px 12px;
+             background-color: #ff3b30;
+             color: white;
+             border: none;
+             border-radius: 4px;
+             cursor: pointer;
+             font-size: 14px;
+             transition: background-color 0.2s;
+         }
+         
+         .logout-button:hover {
+             background-color: #ff453a;
+         }
      </style>
  </head>
  <body>
+     <div class="user-info">
+         <span>欢迎，<span id="username"></span></span>
+         <button class="logout-button" onclick="handleLogout()">退出登录</button>
+     </div>
      <div class="container">
          <h1>杭州新青年夜校课表</h1>
```

```diff
  
      <script>
+         // 获取用户名并显示
+         const username = document.getElementById('username');
+         fetch('/api/table-data')
+             .then(response => {
+                 if (response.redirected) {
+                     window.location.href = response.url;
+                     return;
+                 }
+                 return response.json();
+             })
+             .then(data => {
+                 if (data && data.user) {
+                     username.textContent = data.user.username;
+                 }
+             })
+             .catch(error => {
+                 console.error('获取用户信息失败:', error);
+             });
+             
+         // 处理登出
+         async function handleLogout() {
+             try {
+                 const response = await fetch('/api/logout');
+                 if (response.ok) {
+                     window.location.href = '/login';
+                 }
+             } catch (error) {
+                 console.error('登出失败:', error);
+             }
+         }
+ 
          // 定义区域顺序
          const areaOrder = [
```

---

现在我们需要修改后端 API 以返回用户信息：

---

```diff
              data = await fetchDataFromFeishu();
          }
+         
+         // 添加用户信息到返回数据中
+         data.user = {
+             username: req.session.user.username,
+             phone: req.session.user.phone
+         };
          
          res.json(data);
```

---

好了，现在我们已经完成了用户登录注册功能的实现。主要功能包括：

1. 用户注册：
   - 需要用户名、手机号和密码
   - 验证用户名和手机号是否已被注册
   - 密码使用 bcrypt 加密存储

2. 用户登录：
   - 使用用户名和密码登录
   - 登录成功后创建会话
   - 登录失败提供友好的错误提示

3. 访问控制：
   - 未登录用户会被重定向到登录页面
   - 已登录用户访问登录/注册页面会被重定向到首页
   - 所有课表相关的 API 都需要登录才能访问

4. 用户界面：
   - 登录和注册页面采用苹果风格设计
   - 首页顶部显示当前用户名
   - 提供退出登录按钮

要启动服务器，请运行：

---

```bash
node app.js
```

```
(base) burning@192 基于飞书表格的夜校后台 % node app.js
[info]: [ 'client ready' ]
服务器运行在 http://localhost:4000
```

---

现在你可以访问以下地址来测试功能：

1. 注册页面：http://localhost:4000/register
2. 登录页面：http://localhost:4000/login
3. 主页：http://localhost:4000

系统会自动处理页面重定向：
- 未登录用户访问主页会被重定向到登录页面
- 已登录用户访问登录/注册页面会被重定向到主页

建议的后续优化方向：

1. 安全性提升：
   - 添加密码强度要求
   - 实现手机号验证码功能
   - 添加登录失败次数限制
   - 实现"记住我"功能

2. 用户体验优化：
   - 添加用户信息修改功能
   - 实现密码重置功能
   - 添加用户操作日志
   - 优化表单验证和错误提示

3. 管理功能：
   - 添加管理员角色
   - 实现用户管理功能
   - 添加数据访问权限控制

需要实现其中任何功能，请随时告诉我。

---

